---
title: "omicron_case"
output: html_document
---
#Taking difference in growth rate in omicron (BA.1) vs its corresponding clade 
#

```{r}
library(readr)
library(tidyverse)
library(ggplot2)
library(nnet)
library(MASS)
library(MNLpred)
```


#read in clade and PANGO lineage counts accessed June 5th  
```{r}
cladenum <- read_tsv("~/growthadvantagecompare/sequences_static/global-2.tsv") %>% rename(variant = clade)

#https://data.nextstrain.org/files/workflows/forecasts-ncov/gisaid/pango_lineages/global.tsv.gz

pangonum <- read_tsv("~/growthadvantagecompare/sequences_static/global.tsv") %>% rename(variant = clade)

#https://data.nextstrain.org/files/workflows/forecasts-ncov/gisaid/nextstrain_clades/global.tsv.gz

https://ncov-clades-schema.vercel.app
```


#Plot counts of BA.1 (Omicron 1) vs clade 21K in USA
```{r}
#restrict data to first appearance of clade (because clade is assigned when growth of pango lineage is high)

usa_pBA1 <- pangonum %>% filter(location == "USA", variant == c("BA.1")) %>% mutate("Unit"= "Pangolin BA.1")

usa_c21K <- cladenum %>% filter(location == "USA", variant == "21K")  %>% mutate("Unit"= "Clade 21K")

mindate <- min(usa_c21K$date + 500) 
maxdate <- mindate + 730

usa_c21kpBa1 <- bind_rows(usa_c21K, usa_pBA1) %>% 
  filter(date < maxdate & date > mindate)


ggplot(usa_c21kpBa1, aes(x = date, y = sequences, fill = Unit)) + 
  geom_col() +
  labs(title = "Pango lineage and Clade Seq Volume") +
  theme_minimal()


```
#Plot all sequences volume by day (should be the same)
```{r}
#tot n per day

cladetotn_usa <- cladenum %>% filter(location == "USA") %>% 
  group_by(date) %>% summarise(totn = sum(sequences)) %>% 
  mutate("source" = "Clade")

pangototn_usa <- pangonum %>% filter(location == "USA") %>% 
  group_by(date) %>% summarise(totn = sum(sequences)) %>% 
  mutate("source" = "Pangolin")


ggplot() +
  geom_col(data = cladetotn_usa %>% filter(source == "Clade"),
           aes(x = date, y = totn, fill = source), alpha = 0.8) +
  geom_line(data = pangototn_usa %>% filter(source == "Pangolin"),
            aes(x = date, y = totn, color = source), size = 1.5, opacity = .3) +
  scale_fill_manual(values = c("Clade" = "coral")) +
  scale_color_manual(values = c("Pangolin" = "steelblue")) +
  labs(
    title = "Total Sequences by Unit Over Time (Ensure consistency)",
    x = "Date",
    y = "Total Sequences",
    fill = "Source",
    color = "Source"
  ) +
  theme_minimal()

```
#Plot proportions of clade and pangos in time frame
```{r}

#New max ad min date, filter to where first emerged pango (BA.1) prop above 5% and add a year 

pangoprops_usa <- left_join(pangototn_usa, pangonum %>% filter(location == "USA"), by = "date") %>% 
  mutate(pangoprop = sequences/totn)

cladeprops_usa <- left_join(cladetotn_usa, cladenum %>% filter(location == "USA"), by = "date") %>% 
  mutate(cladeprop = sequences/totn)

mindate <- pangoprops_usa %>% filter(variant == "BA.1", pangoprop > .1) %>% 
summarise(date = min(date)) %>% 
pull(.)

maxdate <- mindate + 365


ggplot(data = cladeprops_usa %>% filter(variant == c("21K", "21L", "22C"), date > mindate & date < maxdate), aes(x = date, y = cladeprop, color = variant)) +
  geom_point(alpha = 0.7) +
  labs(
    title = "Clade Proportions Over Time",
    x = "Date",
    y = "Proportion",
    color = "Variant"
  ) +
  theme_minimal()

#filtered
ggplot(data = pangoprops_usa %>% filter(variant == c("BA.1", "BA.2", "BA.2.12.1"), date > mindate & date < maxdate), aes(x = date, y = pangoprop, color = variant)) +
  geom_point(alpha = 0.7) +
  labs(
    title = "Pango Proportions Over Time",
    x = "Date",
    y = "Proportion",
    color = "Variant"
  ) +
  theme_minimal()





```
#For clades
```{r}

set.seed(123)

#make date an integer and ungroup observations, makes a lot of observations so slice at 50k
mlr_cladeprops_usa <- cladeprops_usa %>%
  filter(date >= mindate & date <= maxdate) %>%
  mutate(time = as.integer(date - mindate)) %>%
  uncount(sequences) %>%
  slice_sample(n = 80000)


gc()

mod1 <- multinom(variant ~ time,
                 data = mlr_cladeprops_usa,
                 Hess = TRUE,
                 maxit = 1000)
gc()

pred1 <- mnl_pred_ova(model = mod1,
                      data = mlr_cladeprops_usa,
                      x = "time",
                      by = 7,
                      seed = 123,
                      nsim = 5, # faster
                      probs = c(0.025, 0.975)) # default




pred1$plotdata <- pred1$plotdata %>%
  mutate(date = mindate + time)


ggplot() +
  geom_point(
    data = cladeprops_usa %>% filter(date > mindate & date < maxdate),
    aes(x = date, y = cladeprop, color = variant),
    alpha = 0.6) +
  geom_line(
    data = pred1$plotdata %>% filter(date > mindate & date < maxdate),
    aes(x = date, y = mean, color = variant),
    size = 1
  ) +
  labs(
    title = "USA Clades Vs MLR Model Fit",
    x = "Date",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank())


```

